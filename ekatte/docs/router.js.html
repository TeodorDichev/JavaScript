<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>router.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#altitudeHandler">altitudeHandler</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#checkEkatteFormat">checkEkatteFormat</a></li><li><a href="global.html#checkIsAlphaNumerical">checkIsAlphaNumerical</a></li><li><a href="global.html#checkIsOnlyAlphabetical">checkIsOnlyAlphabetical</a></li><li><a href="global.html#checkIsOnlyNumerical">checkIsOnlyNumerical</a></li><li><a href="global.html#checkMayoralityCodeFormat">checkMayoralityCodeFormat</a></li><li><a href="global.html#checkMayoralityExists">checkMayoralityExists</a></li><li><a href="global.html#checkMayoralityHasMunicipalityOrRegionCenters">checkMayoralityHasMunicipalityOrRegionCenters</a></li><li><a href="global.html#checkMunicipalityCodeFormat">checkMunicipalityCodeFormat</a></li><li><a href="global.html#checkMunicipalityExists">checkMunicipalityExists</a></li><li><a href="global.html#checkMunicipalityHasRegionCenters">checkMunicipalityHasRegionCenters</a></li><li><a href="global.html#checkNuts3Exists">checkNuts3Exists</a></li><li><a href="global.html#checkNuts3Format">checkNuts3Format</a></li><li><a href="global.html#checkRegionCodeFormat">checkRegionCodeFormat</a></li><li><a href="global.html#checkRegionExists">checkRegionExists</a></li><li><a href="global.html#checkSettlementExists">checkSettlementExists</a></li><li><a href="global.html#checkSettlementIsCenter">checkSettlementIsCenter</a></li><li><a href="global.html#createMayoralityHandler">createMayoralityHandler</a></li><li><a href="global.html#createMunicipalityHandler">createMunicipalityHandler</a></li><li><a href="global.html#createRegionHandler">createRegionHandler</a></li><li><a href="global.html#createSettlementHandler">createSettlementHandler</a></li><li><a href="global.html#csvExportHandler">csvExportHandler</a></li><li><a href="global.html#deleteMayoralityHandler">deleteMayoralityHandler</a></li><li><a href="global.html#deleteMunicipalityHandler">deleteMunicipalityHandler</a></li><li><a href="global.html#deleteRegionHandler">deleteRegionHandler</a></li><li><a href="global.html#deleteSettlementHandler">deleteSettlementHandler</a></li><li><a href="global.html#editMayoralityHandler">editMayoralityHandler</a></li><li><a href="global.html#editMunicipalityHandler">editMunicipalityHandler</a></li><li><a href="global.html#editRegionHandler">editRegionHandler</a></li><li><a href="global.html#editSettlementHandler">editSettlementHandler</a></li><li><a href="global.html#excelExportHandler">excelExportHandler</a></li><li><a href="global.html#exportCsvMayoralityHandler">exportCsvMayoralityHandler</a></li><li><a href="global.html#exportCsvMunicipalityHandler">exportCsvMunicipalityHandler</a></li><li><a href="global.html#exportCsvRegionHandler">exportCsvRegionHandler</a></li><li><a href="global.html#exportCsvSettlementHandler">exportCsvSettlementHandler</a></li><li><a href="global.html#exportExcelMayoralityHandler">exportExcelMayoralityHandler</a></li><li><a href="global.html#exportExcelMunicipalityHandler">exportExcelMunicipalityHandler</a></li><li><a href="global.html#exportExcelRegionHandler">exportExcelRegionHandler</a></li><li><a href="global.html#exportExcelSettlementHandler">exportExcelSettlementHandler</a></li><li><a href="global.html#formatNullValues">formatNullValues</a></li><li><a href="global.html#getRequestBody">getRequestBody</a></li><li><a href="global.html#globalSearchHandler">globalSearchHandler</a></li><li><a href="global.html#homeMayoralityHandler">homeMayoralityHandler</a></li><li><a href="global.html#homeMunicipalityHandler">homeMunicipalityHandler</a></li><li><a href="global.html#homeRegionHandler">homeRegionHandler</a></li><li><a href="global.html#homeSettlementsHandler">homeSettlementsHandler</a></li><li><a href="global.html#infoMayoralityHandler">infoMayoralityHandler</a></li><li><a href="global.html#infoMunicipalityHandler">infoMunicipalityHandler</a></li><li><a href="global.html#infoRegionHandler">infoRegionHandler</a></li><li><a href="global.html#infoSettlementHandler">infoSettlementHandler</a></li><li><a href="global.html#isPositiveInteger">isPositiveInteger</a></li><li><a href="global.html#mayoralityCenterCandidatesHandler">mayoralityCenterCandidatesHandler</a></li><li><a href="global.html#municipalityCenterCandidatesHandler">municipalityCenterCandidatesHandler</a></li><li><a href="global.html#regionCenterCandidatesHandler">regionCenterCandidatesHandler</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#searchMayoralityHandler">searchMayoralityHandler</a></li><li><a href="global.html#searchMunicipalityHandler">searchMunicipalityHandler</a></li><li><a href="global.html#searchRegionHandler">searchRegionHandler</a></li><li><a href="global.html#sendResponse">sendResponse</a></li><li><a href="global.html#settlementTypeHandler">settlementTypeHandler</a></li><li><a href="global.html#validateEkatteHandler">validateEkatteHandler</a></li><li><a href="global.html#validateMayoralityCodeHandler">validateMayoralityCodeHandler</a></li><li><a href="global.html#validateMayoralityDependenciesHandler">validateMayoralityDependenciesHandler</a></li><li><a href="global.html#validateMunicipalityCodeHandler">validateMunicipalityCodeHandler</a></li><li><a href="global.html#validateMunicipalityDependenciesHandler">validateMunicipalityDependenciesHandler</a></li><li><a href="global.html#validateNutsHandler">validateNutsHandler</a></li><li><a href="global.html#validateRegionCodeHandler">validateRegionCodeHandler</a></li><li><a href="global.html#validateSettlementDependenciesHandler">validateSettlementDependenciesHandler</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">router.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Central API router.
 * Handles URL parsing and maps incoming HTTP requests to the correct 
 * administrative controllers.
 */

import { URL } from "url";
import { pool } from "./server.js";
import { sendResponse } from "./utils/response-helper.js";

import * as settlement from "./controllers/settlement-controller.js";
import * as mayorality from "./controllers/mayorality-controller.js";
import * as municipality from "./controllers/municipality-controller.js";
import * as region from "./controllers/region-controller.js";
import * as home from "./controllers/home-controller.js";
import * as exportController from "./controllers/export-controller.js";
import { altitudeHandler } from "./controllers/altitude-controller.js";
import { settlementTypeHandler } from "./controllers/settlement-type-controller.js";
import * as validation from "./controllers/validation-controller.js";

/**
 * Main application router that dispatches incoming requests to specific controllers.
 * Establishes a database connection from the pool and ensures the database client 
 * is released back to the pool in all scenarios.
 * 
 * @async
 * @param {http.IncomingMessage} req - The Node.js HTTP request object.
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {pg.Pool} [dbpool=pool] - The PostgreSQL connection pool (defaults to the global pool).
 * @returns {Promise&lt;void>} - Resolves when the request has been fully handled and response sent.
 */
export async function router(req, res, dbpool = pool) {
    const client = await dbpool.connect();

    try {
        const base = `http://${req.headers.host}`;
        const parsedUrl = new URL(req.url, base);
        const method = req.method;

        let bodyData = {};
        if (method === "POST" || method === "PUT") {
            try {
                bodyData = await getRequestBody(req);
            } catch (err) {
                return sendResponse(res, 400, { message: "Invalid JSON format", errors: [err.message] });
            }
        }

        const [, api, resource, action] = parsedUrl.pathname.split("/");
        if (api !== "api") return sendResponse(res, 404, { message: "Not Found" });

        if (resource === "stats" &amp;&amp; method === "GET") return await home.globalSearchHandler(res, parsedUrl, client);
        if (resource === "csv-export" &amp;&amp; method === "GET") return await exportController.csvExportHandler(res, client)
        if (resource === "excel-export" &amp;&amp; method === "GET") return await exportController.excelExportHandler(res, client);

        if (resource === "settlement") {
            if (action === "home" &amp;&amp; method === "GET") return await settlement.homeSettlementsHandler(res, parsedUrl, client);
            if (action === "info" &amp;&amp; method === "GET") return await settlement.infoSettlementHandler(res, parsedUrl, client);
            if (action === "create" &amp;&amp; method === "POST") return await settlement.createSettlementHandler(res, client, bodyData);
            if (action === "update" &amp;&amp; method === "PUT") return await settlement.editSettlementHandler(res, parsedUrl, client, bodyData);
            if (action === "delete" &amp;&amp; method === "DELETE") return await settlement.deleteSettlementHandler(res, parsedUrl, client);
            if (action === "csv-export" &amp;&amp; method === "GET") return await settlement.exportCsvSettlementHandler(res, parsedUrl, client);
            if (action === "excel-export" &amp;&amp; method === "GET") return await settlement.exportExcelSettlementHandler(res, parsedUrl, client);
        }

        if (resource === "mayorality") {
            if (action === "center-candidates" &amp;&amp; method === "GET") return await mayorality.mayoralityCenterCandidatesHandler(res, parsedUrl, client);
            if (action === "home" &amp;&amp; method === "GET") return await mayorality.homeMayoralityHandler(res, parsedUrl, client);
            if (action === "search" &amp;&amp; method === "GET") return await mayorality.searchMayoralityHandler(res, parsedUrl, client);
            if (action === "info" &amp;&amp; method === "GET") return await mayorality.infoMayoralityHandler(res, parsedUrl, client);
            if (action === "create" &amp;&amp; method === "POST") return await mayorality.createMayoralityHandler(res, client, bodyData);
            if (action === "update" &amp;&amp; method === "PUT") return await mayorality.editMayoralityHandler(res, parsedUrl, client, bodyData);
            if (action === "delete" &amp;&amp; method === "DELETE") return await mayorality.deleteMayoralityHandler(res, parsedUrl, client);
            if (action === "csv-export" &amp;&amp; method === "GET") return await mayorality.exportCsvMayoralityHandler(res, parsedUrl, client);
            if (action === "excel-export" &amp;&amp; method === "GET") return await mayorality.exportExcelMayoralityHandler(res, parsedUrl, client);
        }

        if (resource === "municipality") {
            if (action === "center-candidates" &amp;&amp; method === "GET") return await municipality.municipalityCenterCandidatesHandler(res, parsedUrl, client);
            if (action === "home" &amp;&amp; method === "GET") return await municipality.homeMunicipalityHandler(res, parsedUrl, client);
            if (action === "search" &amp;&amp; method === "GET") return await municipality.searchMunicipalityHandler(res, parsedUrl, client);
            if (action === "info" &amp;&amp; method === "GET") return await municipality.infoMunicipalityHandler(res, parsedUrl, client);
            if (action === "create" &amp;&amp; method === "POST") return await municipality.createMunicipalityHandler(res, client, bodyData);
            if (action === "update" &amp;&amp; method === "PUT") return await municipality.editMunicipalityHandler(res, parsedUrl, client, bodyData);
            if (action === "delete" &amp;&amp; method === "DELETE") return await municipality.deleteMunicipalityHandler(res, parsedUrl, client);
            if (action === "csv-export" &amp;&amp; method === "GET") return await municipality.exportCsvMunicipalityHandler(res, parsedUrl, client);
            if (action === "excel-export" &amp;&amp; method === "GET") return await municipality.exportExcelMunicipalityHandler(res, parsedUrl, client);
        }

        if (resource === "region") {
            if (action === "center-candidates" &amp;&amp; method === "GET") return await region.regionCenterCandidatesHandler(res, parsedUrl, client);
            if (action === "home" &amp;&amp; method === "GET") return await region.homeRegionHandler(res, parsedUrl, client);
            if (action === "info" &amp;&amp; method === "GET") return await region.infoRegionHandler(res, parsedUrl, client);
            if (action === "search" &amp;&amp; method === "GET") return await region.searchRegionHandler(res, parsedUrl, client);
            if (action === "create" &amp;&amp; method === "POST") return await region.createRegionHandler(res, client, bodyData);
            if (action === "update" &amp;&amp; method === "PUT") return await region.editRegionHandler(res, parsedUrl, client, bodyData);
            if (action === "delete" &amp;&amp; method === "DELETE") return await region.deleteRegionHandler(res, parsedUrl, client);
            if (action === "csv-export" &amp;&amp; method === "GET") return await region.exportCsvRegionHandler(res, parsedUrl, client);
            if (action === "excel-export" &amp;&amp; method === "GET") return await region.exportExcelRegionHandler(res, parsedUrl, client);
        }

        if (resource === "altitude" &amp;&amp; action === "search" &amp;&amp; method === "GET") return await altitudeHandler(res, client);
        if (resource === "settlement_type" &amp;&amp; action === "search" &amp;&amp; method === "GET") return await settlementTypeHandler(res, client);

        if (resource === "validation" &amp;&amp; method === "GET") {
            if (action === "ekatte" &amp;&amp; method === "GET") return await validation.validateEkatteHandler(res, parsedUrl, client);
            if (action === "region-code" &amp;&amp; method === "GET") return await validation.validateRegionCodeHandler(res, parsedUrl, client);
            if (action === "municipality-code" &amp;&amp; method === "GET") return await validation.validateMunicipalityCodeHandler(res, parsedUrl, client);
            if (action === "mayorality-code" &amp;&amp; method === "GET") return await validation.validateMayoralityCodeHandler(res, parsedUrl, client);
            if (action === "nuts" &amp;&amp; method === "GET") return await validation.validateNutsHandler(res, parsedUrl, client);
            if (action === "municipality-dependencies" &amp;&amp; method === "GET") return await validation.validateMunicipalityDependenciesHandler(res, parsedUrl, client);
            if (action === "mayorality-dependencies" &amp;&amp; method === "GET") return await validation.validateMayoralityDependenciesHandler(res, parsedUrl, client);
            if (action === "settlement-dependencies" &amp;&amp; method === "GET") return await validation.validateSettlementDependenciesHandler(res, parsedUrl, client);
        }

        return sendResponse(res, 404, { message: "Resource or Action not found"});

    } catch (err) {
        return sendResponse(res, 500, { message: "Critical Router Error", errors: [err.message] });
    } finally {
        client.release();
    }
}

/**
 * Parses the incoming request stream and returns the JSON body.
 * @async
 * @param {http.IncomingMessage} req - The Node.js request object.
 * @returns {Promise&lt;Object>} A promise that resolves to the parsed JSON object.
 * @throws {SyntaxError} If the request body is not valid JSON.
 */
async function getRequestBody(req) {
    let body = "";
    for await (const chunk of req) body += chunk;
    if (!body) return {};
    return JSON.parse(body);
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Jan 13 2026 14:30:59 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
