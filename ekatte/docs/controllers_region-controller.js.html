<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/region-controller.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#altitudeHandler">altitudeHandler</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#checkEkatteFormat">checkEkatteFormat</a></li><li><a href="global.html#checkIsAlphaNumerical">checkIsAlphaNumerical</a></li><li><a href="global.html#checkIsOnlyAlphabetical">checkIsOnlyAlphabetical</a></li><li><a href="global.html#checkIsOnlyNumerical">checkIsOnlyNumerical</a></li><li><a href="global.html#checkMayoralityCodeFormat">checkMayoralityCodeFormat</a></li><li><a href="global.html#checkMayoralityExists">checkMayoralityExists</a></li><li><a href="global.html#checkMayoralityHasMunicipalityOrRegionCenters">checkMayoralityHasMunicipalityOrRegionCenters</a></li><li><a href="global.html#checkMunicipalityCodeFormat">checkMunicipalityCodeFormat</a></li><li><a href="global.html#checkMunicipalityExists">checkMunicipalityExists</a></li><li><a href="global.html#checkMunicipalityHasRegionCenters">checkMunicipalityHasRegionCenters</a></li><li><a href="global.html#checkNuts3Exists">checkNuts3Exists</a></li><li><a href="global.html#checkNuts3Format">checkNuts3Format</a></li><li><a href="global.html#checkRegionCodeFormat">checkRegionCodeFormat</a></li><li><a href="global.html#checkRegionExists">checkRegionExists</a></li><li><a href="global.html#checkSettlementExists">checkSettlementExists</a></li><li><a href="global.html#checkSettlementIsCenter">checkSettlementIsCenter</a></li><li><a href="global.html#createMayoralityHandler">createMayoralityHandler</a></li><li><a href="global.html#createMunicipalityHandler">createMunicipalityHandler</a></li><li><a href="global.html#createRegionHandler">createRegionHandler</a></li><li><a href="global.html#createSettlementHandler">createSettlementHandler</a></li><li><a href="global.html#csvExportHandler">csvExportHandler</a></li><li><a href="global.html#deleteMayoralityHandler">deleteMayoralityHandler</a></li><li><a href="global.html#deleteMunicipalityHandler">deleteMunicipalityHandler</a></li><li><a href="global.html#deleteRegionHandler">deleteRegionHandler</a></li><li><a href="global.html#deleteSettlementHandler">deleteSettlementHandler</a></li><li><a href="global.html#editMayoralityHandler">editMayoralityHandler</a></li><li><a href="global.html#editMunicipalityHandler">editMunicipalityHandler</a></li><li><a href="global.html#editRegionHandler">editRegionHandler</a></li><li><a href="global.html#editSettlementHandler">editSettlementHandler</a></li><li><a href="global.html#excelExportHandler">excelExportHandler</a></li><li><a href="global.html#exportCsvMayoralityHandler">exportCsvMayoralityHandler</a></li><li><a href="global.html#exportCsvMunicipalityHandler">exportCsvMunicipalityHandler</a></li><li><a href="global.html#exportCsvRegionHandler">exportCsvRegionHandler</a></li><li><a href="global.html#exportCsvSettlementHandler">exportCsvSettlementHandler</a></li><li><a href="global.html#exportExcelMayoralityHandler">exportExcelMayoralityHandler</a></li><li><a href="global.html#exportExcelMunicipalityHandler">exportExcelMunicipalityHandler</a></li><li><a href="global.html#exportExcelRegionHandler">exportExcelRegionHandler</a></li><li><a href="global.html#exportExcelSettlementHandler">exportExcelSettlementHandler</a></li><li><a href="global.html#formatNullValues">formatNullValues</a></li><li><a href="global.html#getRequestBody">getRequestBody</a></li><li><a href="global.html#globalSearchHandler">globalSearchHandler</a></li><li><a href="global.html#homeMayoralityHandler">homeMayoralityHandler</a></li><li><a href="global.html#homeMunicipalityHandler">homeMunicipalityHandler</a></li><li><a href="global.html#homeRegionHandler">homeRegionHandler</a></li><li><a href="global.html#homeSettlementsHandler">homeSettlementsHandler</a></li><li><a href="global.html#infoMayoralityHandler">infoMayoralityHandler</a></li><li><a href="global.html#infoMunicipalityHandler">infoMunicipalityHandler</a></li><li><a href="global.html#infoRegionHandler">infoRegionHandler</a></li><li><a href="global.html#infoSettlementHandler">infoSettlementHandler</a></li><li><a href="global.html#isPositiveInteger">isPositiveInteger</a></li><li><a href="global.html#mayoralityCenterCandidatesHandler">mayoralityCenterCandidatesHandler</a></li><li><a href="global.html#municipalityCenterCandidatesHandler">municipalityCenterCandidatesHandler</a></li><li><a href="global.html#regionCenterCandidatesHandler">regionCenterCandidatesHandler</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#searchMayoralityHandler">searchMayoralityHandler</a></li><li><a href="global.html#searchMunicipalityHandler">searchMunicipalityHandler</a></li><li><a href="global.html#searchRegionHandler">searchRegionHandler</a></li><li><a href="global.html#sendResponse">sendResponse</a></li><li><a href="global.html#settlementTypeHandler">settlementTypeHandler</a></li><li><a href="global.html#validateEkatteHandler">validateEkatteHandler</a></li><li><a href="global.html#validateMayoralityCodeHandler">validateMayoralityCodeHandler</a></li><li><a href="global.html#validateMayoralityDependenciesHandler">validateMayoralityDependenciesHandler</a></li><li><a href="global.html#validateMunicipalityCodeHandler">validateMunicipalityCodeHandler</a></li><li><a href="global.html#validateMunicipalityDependenciesHandler">validateMunicipalityDependenciesHandler</a></li><li><a href="global.html#validateNutsHandler">validateNutsHandler</a></li><li><a href="global.html#validateRegionCodeHandler">validateRegionCodeHandler</a></li><li><a href="global.html#validateSettlementDependenciesHandler">validateSettlementDependenciesHandler</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/region-controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Region resource handlers.
 * Manages top-level administrative divisions, NUTS3 identifiers,
 * and region-wide statistical aggregation.
 */
import ExcelJS from "exceljs";
import * as validation from "../utils/validation.js";
import { sendResponse } from "../utils/response-helper.js";
import { regionModel } from "../models/region-model.js";
import { municipalityModel } from "../models/municipality-model.js";
import { mayoralityModel } from "../models/mayorality-model.js";
import { settlementModel } from "../models/settlement-model.js";
import { calculateStats, formatNullValues } from "../utils/export-helper.js";

/**
 * Route handler to create a new Region along with a starting Municipality, Mayorality, and Center Settlement.
 * Executes a complex multi-table insertion within a single transaction to ensure data integrity
 * across the administrative hierarchy.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @param {Object} bodyData - The request body containing nested objects for region, municipality, mayorality, and center.
 * @returns {Promise&lt;void>}
 */
export async function createRegionHandler(res, client, bodyData) {
  const { region, municipality, mayorality, center } = bodyData;
  const errors = [];

  try {
    if (!center || !region || !municipality || !mayorality) {
      errors.push("Липсващи данни за някой от обектите");
    }
    if (!validation.checkRegionCodeFormat(region?.region_id))
      errors.push("Невалиден код на област");
    if (await validation.checkRegionExists(client, region?.region_id))
      errors.push("Вече има такава област");
    if (
      !validation.checkNuts3Format(region?.nuts3_id) ||
      (await validation.checkNuts3Exists(client, region?.nuts3_id))
    ) {
      errors.push("Невалидна или съществуваща nuts3_id");
    }
    if (await validation.checkSettlementExists(client, center?.ekatte))
      errors.push("Вече съществува такова селище (ekatte)");
    if (
      await validation.checkMunicipalityExists(
        client,
        municipality?.municipality_id
      )
    )
      errors.push("Вече има такава община");
    if (
      await validation.checkMayoralityExists(client, mayorality?.mayorality_id)
    )
      errors.push("Вече има такова кметство");

    if (errors.length > 0) {
      return sendResponse(res, 400, {
        message: "Грешка при валидация",
        errors,
      });
    }

    await client.query("BEGIN");
    await regionModel.create(client, region);
    await municipalityModel.create(client, municipality);
    await mayoralityModel.create(client, mayorality);
    await settlementModel.create(client, center);
    await mayoralityModel.createCenter(client, mayorality?.mayorality_id);
    await municipalityModel.createCenter(client, municipality?.municipality_id);
    await regionModel.createCenter(client, region?.region_id);

    await client.query("COMMIT");

    sendResponse(res, 201, {
      message: "Област, община, кметство и център успешно създадени",
    });
  } catch (err) {
    await client.query("ROLLBACK").catch(() => {});
    sendResponse(res, 500, {
      message: "Възникна системна грешка при записването на областта",
      errors: [err.message],
    });
  }
}

/**
 * Route handler to delete a Region and all its nested administrative subdivisions.
 * Implements a cascading deletion strategy within a transaction, removing associated centers,
 * settlements, mayoralities, and municipalities before removing the region record itself.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL containing the region 'id'.
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @returns {Promise&lt;void>}
 */
export async function deleteRegionHandler(res, parsedUrl, client) {
  const id = parsedUrl.searchParams.get("id")?.trim() ?? "";

  if (!validation.checkRegionCodeFormat(id)) {
    return sendResponse(res, 400, {
      message: "Невалиден формат",
      errors: ["Кодът на областта трябва да бъде в правилен формат"],
    });
  }

  try {
    await client.query("BEGIN");
    await regionModel.deleteMayoralityCentersByRegion(client, id);
    await regionModel.deleteMunicipalityCentersByRegion(client, id);
    await regionModel.deleteRegionCenter(client, id);
    await regionModel.deleteSettlementsByRegion(client, id);
    await regionModel.deleteMayoralitiesByRegion(client, id);
    await regionModel.deleteMunicipalitiesByRegion(client, id);
    const result = await regionModel.deleteRecord(client, id);

    if (result.rowCount === 0) {
      await client.query("ROLLBACK");
      return sendResponse(res, 404, {
        message: "Неуспешно изтриване",
        errors: ["Областта не е намерена"],
      });
    }

    await client.query("COMMIT");
    sendResponse(res, 200, {
      message: "Областта и всички нейни подразделения са изтрити успешно",
    });
  } catch (err) {
    await client.query("ROLLBACK").catch(() => {});
    sendResponse(res, 500, {
      message: "Възникна системна грешка при изтриване",
      errors: [err.message],
    });
  }
}

/**
 * Route handler to update Region attributes and its designated administrative center.
 * Includes validation for NUTS3 identifier uniqueness and format, as well as center settlement existence.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL used to extract the region ID from the path.
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @param {Object} bodyData - Updated region data including potential NUTS3 changes and center_id.
 * @returns {Promise&lt;void>}
 */
export async function editRegionHandler(res, parsedUrl, client, bodyData) {
  const id = parsedUrl.pathname.split("/").pop();
  const errors = [];

  if (!validation.checkRegionCodeFormat(id))
    errors.push("Невалиден код на област");
  if (!validation.checkIsOnlyAlphabetical(bodyData.name))
    errors.push("Невалидно име");
  if (!validation.checkIsOnlyAlphabetical(bodyData.transliteration))
    errors.push("Невалиден превод");
  if (bodyData.changed_nuts3) {
    if (
      !validation.checkNuts3Format(bodyData.nuts3) ||
      (await validation.checkNuts3Exists(client, bodyData.nuts3))
    ) {
      errors.push("Невалиден или съществуващ nuts3_id");
    }
  }
  if (!validation.checkEkatteFormat(bodyData.center_id)) {
    errors.push("Невалиден формат на ekatte");
  } else if (
    !(await validation.checkSettlementExists(client, bodyData.center_id))
  ) {
    errors.push("Не съществува такова селище за център");
  }

  if (errors.length > 0) {
    return sendResponse(res, 400, { message: "Грешка при валидация", errors });
  }

  try {
    await client.query("BEGIN");
    await regionModel.update(client, id, bodyData);
    await regionModel.deleteRegionCenter(client, id);
    if (bodyData.center_id) {
      await regionModel.setCenter(client, id, bodyData.center_id);
    }

    await client.query("COMMIT");

    sendResponse(res, 200, { message: "Успешна редакция на областта" });
  } catch (err) {
    await client.query("ROLLBACK").catch(() => {});
    sendResponse(res, 500, {
      message: "Вътрешна сървърна грешка при редакция",
      errors: [err.message],
    });
  }
}

/**
 * Route handler for lightweight Region searching, typically for autocomplete components.
 * Returns a simplified list of the top 10 matching regions.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL containing the search query (q).
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @returns {Promise&lt;void>}
 */
export async function searchRegionHandler(res, parsedUrl, client) {
  const q = parsedUrl.searchParams.get("q")?.trim() ?? "";
  try {
    const result = await regionModel.getFiltered(client, q);
    const data = result.rows.slice(0, 10).map((row) => ({
      id: row.region_id,
      name: row.region_name,
    }));
    sendResponse(res, 200, { data });
  } catch (err) {
    sendResponse(res, 500, {
      message: "Грешка при търсене на области",
      errors: [err.message],
    });
  }
}

/**
 * Route handler for the Region dashboard/listing page.
 * Provides paginated statistics and total counts, leveraging window functions for efficient
 * metadata retrieval.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL containing pagination, sort, and search parameters.
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @returns {Promise&lt;void>}
 */
export async function homeRegionHandler(res, parsedUrl, client) {
  const q = parsedUrl.searchParams.get("q")?.trim() ?? "";
  const sort = parsedUrl.searchParams.get("sort")?.trim() ?? "";
  const page = parseInt(parsedUrl.searchParams.get("page")) || 1;
  const limit = parseInt(parsedUrl.searchParams.get("limit")) || 20;
  const fromDate = parsedUrl.searchParams.get("fromDate") || null;
  const toDate = parsedUrl.searchParams.get("toDate") || null;
  const offset = (page - 1) * limit;

  const filters = {
    center_ekatte: parsedUrl.searchParams.get("center_ekatte") || null,
    center_name: parsedUrl.searchParams.get("center_name") || null,
    region_id: parsedUrl.searchParams.get("region_id") || null,
    region_name: parsedUrl.searchParams.get("region_name") || null,
    nuts3_id: parsedUrl.searchParams.get("nuts3_id") || null,
  };

  try {
    const rows = await regionModel.getRegionStats(client, {
      q,
      sort,
      limit,
      offset,
      fromDate,
      toDate,
      filters,
    });

    const totalCount = await regionModel.getCount(client);
    const hasActiveFilters = q || fromDate || toDate || Object.values(filters).some(v => v !== null);

    let filteredCount;
    if (hasActiveFilters) {
      filteredCount = await regionModel.getFilteredCount(
        client,
        q,
        fromDate,
        toDate
      );
    } else {
      filteredCount = totalCount;
    }

    const totalRowsAfterFilter =
      rows.length > 0 ? parseInt(rows[0].total_count) : 0;

    sendResponse(res, 200, {
      data: {
        rows: rows,
        totalCount: totalCount,
        filteredCount: filteredCount,
        pagination: {
          total: totalRowsAfterFilter,
          page: page,
          limit: limit,
          totalPages: Math.ceil(totalRowsAfterFilter / limit),
        },
      },
    });
  } catch (err) {
    console.error("Region Search Error:", err);
    sendResponse(res, 500, {
      message: "Грешка при зареждане на области",
      errors: [err.message],
    });
  }
}

/**
 * Route handler to retrieve comprehensive details for a specific Region.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL containing the region ID in the 'q' parameter.
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @returns {Promise&lt;void>}
 */
export async function infoRegionHandler(res, parsedUrl, client) {
  const id = parsedUrl.searchParams.get("q")?.trim() ?? "";
  try {
    const result = await regionModel.getInfo(client, id);
    sendResponse(res, 200, { data: result });
  } catch (err) {
    sendResponse(res, 500, {
      message: "Грешка при детайли на област",
      errors: [err.message],
    });
  }
}

/**
 * Route handler to fetch a list of settlements within a specific Region that are eligible
 * to be designated as the regional administrative center.
 * @async
 * @param {http.ServerResponse} res - The Node.js HTTP response object.
 * @param {URL} parsedUrl - The parsed request URL containing search string (q) and region ID (id).
 * @param {pg.Client} client - The PostgreSQL database client instance.
 * @returns {Promise&lt;void>}
 */
export async function regionCenterCandidatesHandler(res, parsedUrl, client) {
  const q = parsedUrl.searchParams.get("q")?.trim() ?? "";
  const id = parsedUrl.searchParams.get("id")?.trim() ?? "";
  try {
    const result = await regionModel.getCenterCandidates(client, q, id);
    sendResponse(res, 200, { data: result.rows.slice(0, 10) });
  } catch (err) {
    sendResponse(res, 500, {
      message: "Грешка при кандидати за център",
      errors: [err.message],
    });
  }
}

/**
 * Generates a single Excel file for regions.
 * @param {Object} res - Express response object.
 * @param {URL} parsedUrl - The parsed request URL with q, sort, page, and limit parameters.
 * @param {pg.Client} client - The PostgreSQL client instance.
 * @returns {Promise&lt;void>}
 */
export async function exportExcelRegionHandler(res, parsedUrl, client) {
  const start = performance.now();
  const startUsage = process.cpuUsage();

  const q = parsedUrl.searchParams.get("q")?.trim() ?? "";
  const sort = parsedUrl.searchParams.get("sort")?.trim() ?? "";
  const fromDate = parsedUrl.searchParams.get("fromDate") || null;
  const toDate = parsedUrl.searchParams.get("toDate") || null;

  const filters = {
    center_ekatte: parsedUrl.searchParams.get("center_ekatte") || null,
    center_name: parsedUrl.searchParams.get("center_name") || null,
    region_id: parsedUrl.searchParams.get("region_id") || null,
    region_name: parsedUrl.searchParams.get("region_name") || null,
    nuts3_id: parsedUrl.searchParams.get("nuts3_id") || null,
  };

  try {
    const workbook = new ExcelJS.Workbook();
    const data = await regionModel.getRegionStats(client, {
      q,
      sort,
      limit: null,
      offset: 0,
      fromDate,
      toDate,
      filters
    });
    const sheet = workbook.addWorksheet("Regions");
    const columnMapping = [
      { key: "center_ekatte", header: "Ekatte" },
      { key: "center_name", header: "Име на център" },
      { key: "region_id", header: "Код на областта" },
      { key: "region_name", header: "Име на областта" },
      { key: "nuts3_id", header: "NUTS3" },
      { key: "region_last_change", header: "Промяна" },
    ];

    if (data.length > 0) {
      sheet.columns = columnMapping.map((col) => ({
        header: col.header,
        key: col.key,
        width: 20,
      }));

      sheet.addRows(formatNullValues(data));
    }

    const buffer = await workbook.xlsx.writeBuffer();
    return sendResponse(res, 200, {
      data: {
        payload: {
          blob: buffer.toString("base64"),
          performance: calculateStats(start, startUsage),
        },
        filename: `region_export_excel_${Date.now()}.xlsx`,
      },
    });
  } catch (error) {
    console.error("Region Excel Export Error:", error);
    return sendResponse(res, 500, { message: "Error generating Excel file" });
  }
}

/**
 * Generates a single CSV file for regions.
 * @param {Object} res - Express response object.
 * @param {URL} parsedUrl - The parsed request URL with q, sort, page, and limit parameters.
 * @param {pg.Client} client - The PostgreSQL client instance.
 * @returns {Promise&lt;void>}
 */
export async function exportCsvRegionHandler(res, parsedUrl, client) {
  const start = performance.now();
  const startUsage = process.cpuUsage();

  const q = parsedUrl.searchParams.get("q")?.trim() ?? "";
  const sort = parsedUrl.searchParams.get("sort")?.trim() ?? "";
  const fromDate = parsedUrl.searchParams.get("fromDate") || null;
  const toDate = parsedUrl.searchParams.get("toDate") || null;

  const filters = {
    center_ekatte: parsedUrl.searchParams.get("center_ekatte") || null,
    center_name: parsedUrl.searchParams.get("center_name") || null,
    region_id: parsedUrl.searchParams.get("region_id") || null,
    region_name: parsedUrl.searchParams.get("region_name") || null,
    nuts3_id: parsedUrl.searchParams.get("nuts3_id") || null,
  };

  try {
    const rawData = await regionModel.getRegionStats(client, {
      q,
      sort,
      limit: null,
      offset: 0,
      fromDate,
      toDate,
      filters
    });
    const data = formatNullValues(rawData);
    let csvContent = "";

    const columnMapping = [
      { key: "center_ekatte", header: "Ekatte" },
      { key: "center_name", header: "Име на център" },
      { key: "region_id", header: "Код на областта" },
      { key: "region_name", header: "Име на областта" },
      { key: "nuts3_id", header: "NUTS3" },
      { key: "region_last_change", header: "Промяна" },
    ];

    if (data.length > 0) {
      const headerRow = columnMapping.map((m) => m.header).join(",");
      const rows = data
        .map((item) =>
          columnMapping
            .map((m) => {
              const value = item[m.key] ?? "";
              const escaped = String(value).replace(/"/g, '""');
              return `"${escaped}"`;
            })
            .join(",")
        )
        .join("\n");

      const BOM = "\uFEFF";
      csvContent = BOM + headerRow + "\n" + rows;
    }

    return sendResponse(res, 200, {
      data: {
        payload: {
          blob: Buffer.from(csvContent).toString("base64"),
          performance: calculateStats(start, startUsage),
        },
        filename: `region_export_csv_${Date.now()}.csv`,
      },
    });
  } catch (error) {
    console.error("Region CSV Export Error:", error);
    return sendResponse(res, 500, { message: "Error generating CSV file" });
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Jan 13 2026 14:30:59 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
