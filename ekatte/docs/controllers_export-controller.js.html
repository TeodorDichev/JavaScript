<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/export-controller.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#altitudeHandler">altitudeHandler</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#checkEkatteFormat">checkEkatteFormat</a></li><li><a href="global.html#checkIsAlphaNumerical">checkIsAlphaNumerical</a></li><li><a href="global.html#checkIsOnlyAlphabetical">checkIsOnlyAlphabetical</a></li><li><a href="global.html#checkIsOnlyNumerical">checkIsOnlyNumerical</a></li><li><a href="global.html#checkMayoralityCodeFormat">checkMayoralityCodeFormat</a></li><li><a href="global.html#checkMayoralityExists">checkMayoralityExists</a></li><li><a href="global.html#checkMayoralityHasMunicipalityOrRegionCenters">checkMayoralityHasMunicipalityOrRegionCenters</a></li><li><a href="global.html#checkMunicipalityCodeFormat">checkMunicipalityCodeFormat</a></li><li><a href="global.html#checkMunicipalityExists">checkMunicipalityExists</a></li><li><a href="global.html#checkMunicipalityHasRegionCenters">checkMunicipalityHasRegionCenters</a></li><li><a href="global.html#checkNuts3Exists">checkNuts3Exists</a></li><li><a href="global.html#checkNuts3Format">checkNuts3Format</a></li><li><a href="global.html#checkRegionCodeFormat">checkRegionCodeFormat</a></li><li><a href="global.html#checkRegionExists">checkRegionExists</a></li><li><a href="global.html#checkSettlementExists">checkSettlementExists</a></li><li><a href="global.html#checkSettlementIsCenter">checkSettlementIsCenter</a></li><li><a href="global.html#createMayoralityHandler">createMayoralityHandler</a></li><li><a href="global.html#createMunicipalityHandler">createMunicipalityHandler</a></li><li><a href="global.html#createRegionHandler">createRegionHandler</a></li><li><a href="global.html#createSettlementHandler">createSettlementHandler</a></li><li><a href="global.html#csvExportHandler">csvExportHandler</a></li><li><a href="global.html#deleteMayoralityHandler">deleteMayoralityHandler</a></li><li><a href="global.html#deleteMunicipalityHandler">deleteMunicipalityHandler</a></li><li><a href="global.html#deleteRegionHandler">deleteRegionHandler</a></li><li><a href="global.html#deleteSettlementHandler">deleteSettlementHandler</a></li><li><a href="global.html#editMayoralityHandler">editMayoralityHandler</a></li><li><a href="global.html#editMunicipalityHandler">editMunicipalityHandler</a></li><li><a href="global.html#editRegionHandler">editRegionHandler</a></li><li><a href="global.html#editSettlementHandler">editSettlementHandler</a></li><li><a href="global.html#excelExportHandler">excelExportHandler</a></li><li><a href="global.html#exportCsvMayoralityHandler">exportCsvMayoralityHandler</a></li><li><a href="global.html#exportCsvMunicipalityHandler">exportCsvMunicipalityHandler</a></li><li><a href="global.html#exportCsvRegionHandler">exportCsvRegionHandler</a></li><li><a href="global.html#exportCsvSettlementHandler">exportCsvSettlementHandler</a></li><li><a href="global.html#exportExcelMayoralityHandler">exportExcelMayoralityHandler</a></li><li><a href="global.html#exportExcelMunicipalityHandler">exportExcelMunicipalityHandler</a></li><li><a href="global.html#exportExcelRegionHandler">exportExcelRegionHandler</a></li><li><a href="global.html#exportExcelSettlementHandler">exportExcelSettlementHandler</a></li><li><a href="global.html#formatNullValues">formatNullValues</a></li><li><a href="global.html#getRequestBody">getRequestBody</a></li><li><a href="global.html#globalSearchHandler">globalSearchHandler</a></li><li><a href="global.html#homeMayoralityHandler">homeMayoralityHandler</a></li><li><a href="global.html#homeMunicipalityHandler">homeMunicipalityHandler</a></li><li><a href="global.html#homeRegionHandler">homeRegionHandler</a></li><li><a href="global.html#homeSettlementsHandler">homeSettlementsHandler</a></li><li><a href="global.html#infoMayoralityHandler">infoMayoralityHandler</a></li><li><a href="global.html#infoMunicipalityHandler">infoMunicipalityHandler</a></li><li><a href="global.html#infoRegionHandler">infoRegionHandler</a></li><li><a href="global.html#infoSettlementHandler">infoSettlementHandler</a></li><li><a href="global.html#isPositiveInteger">isPositiveInteger</a></li><li><a href="global.html#mayoralityCenterCandidatesHandler">mayoralityCenterCandidatesHandler</a></li><li><a href="global.html#municipalityCenterCandidatesHandler">municipalityCenterCandidatesHandler</a></li><li><a href="global.html#regionCenterCandidatesHandler">regionCenterCandidatesHandler</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#searchMayoralityHandler">searchMayoralityHandler</a></li><li><a href="global.html#searchMunicipalityHandler">searchMunicipalityHandler</a></li><li><a href="global.html#searchRegionHandler">searchRegionHandler</a></li><li><a href="global.html#sendResponse">sendResponse</a></li><li><a href="global.html#settlementTypeHandler">settlementTypeHandler</a></li><li><a href="global.html#validateEkatteHandler">validateEkatteHandler</a></li><li><a href="global.html#validateMayoralityCodeHandler">validateMayoralityCodeHandler</a></li><li><a href="global.html#validateMayoralityDependenciesHandler">validateMayoralityDependenciesHandler</a></li><li><a href="global.html#validateMunicipalityCodeHandler">validateMunicipalityCodeHandler</a></li><li><a href="global.html#validateMunicipalityDependenciesHandler">validateMunicipalityDependenciesHandler</a></li><li><a href="global.html#validateNutsHandler">validateNutsHandler</a></li><li><a href="global.html#validateRegionCodeHandler">validateRegionCodeHandler</a></li><li><a href="global.html#validateSettlementDependenciesHandler">validateSettlementDependenciesHandler</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/export-controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ExcelJS from 'exceljs';
import JSZip from 'jszip';
import { performance } from 'perf_hooks';

import { settlementModel } from '../models/settlement-model.js';
import { municipalityModel } from '../models/municipality-model.js';
import { regionModel } from '../models/region-model.js';
import { mayoralityModel } from '../models/mayorality-model.js';

import { sendResponse } from '../utils/response-helper.js';
import { calculateStats, formatNullValues } from '../utils/export-helper.js';

/**
 * Generates a ZIP archive containing Excel files for all database entities.
 * @param {Object} res - Express response object.
 * @param {pg.Client} client - The PostgreSQL client instance.
 * @returns {Promise&lt;void>}
 */
export async function excelExportHandler(res, client) {
    const start = performance.now();
    const startUsage = process.cpuUsage();

    try {
        const zip = new JSZip();
        const tables = [
            { name: 'settlements', model: settlementModel, title: 'Settlements' },
            { name: 'municipalities', model: municipalityModel, title: 'Municipalities' },
            { name: 'regions', model: regionModel, title: 'Regions' },
            { name: 'mayoralities', model: mayoralityModel, title: 'Mayoralities' }
        ];

        for (const table of tables) {
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet(table.title);
            const rawData = await table.model.getExportData(client); 
            const data = formatNullValues(rawData);

            if (data.length > 0) {
                const columns = Object.keys(data[0]).map(key => ({
                    header: key.toUpperCase(),
                    key: key,
                    width: 20
                }));
                sheet.columns = columns;
                sheet.addRows(data);
            }

            const buffer = await workbook.xlsx.writeBuffer();
            zip.file(`${table.name}.xlsx`, buffer);
        }

        const archiveBuffer = await zip.generateAsync({ type: "nodebuffer" });
        
        return sendResponse(res, 200, {
            data: {
                payload: {
                    blob: archiveBuffer.toString('base64'),
                    performance: calculateStats(start, startUsage)
                },
                filename: `full_export_excel_${Date.now()}.zip`
            },
        });

    } catch (error) {
        console.error("Excel Export Error:", error);
        return sendResponse(res, 500, { message: "Error generating Excel archive" });
    }
}

/**
 * Generates a ZIP archive containing CSV files for all database entities.
 * @param {Object} res - Express response object.
 * @param {pg.Client} client - The PostgreSQL client instance.
 * @returns {Promise&lt;void>}
 */
export async function csvExportHandler(res, client) {
    const start = performance.now();
    const startUsage = process.cpuUsage();

    try {
        const zip = new JSZip();
        const BOM = '\uFEFF';
        const tables = [
            { name: 'settlements', model: settlementModel, title: 'Settlements' },
            { name: 'municipalities', model: municipalityModel, title: 'Municipalities' },
            { name: 'regions', model: regionModel, title: 'Regions' },
            { name: 'mayoralities', model: mayoralityModel, title: 'Mayoralities' }
        ];

        for (const table of tables) {
            const rawData = await table.model.getExportData(client);
            const data = formatNullValues(rawData);
            
            if (data.length > 0) {
                const keys = Object.keys(data[0]);
                const headers = keys.join(',');
                
                const rows = data.map(item => 
                    keys.map(key => {
                        const val = item[key];
                        const escaped = String(val).replace(/"/g, '""');
                        return `"${escaped}"`;
                    }).join(',')
                ).join('\n');
                
                const csvContent = `${BOM}${headers}\n${rows}`;
                zip.file(`${table.name}.csv`, csvContent);
            }
        }

        const archiveBuffer = await zip.generateAsync({ type: "nodebuffer" });

        return sendResponse(res, 200, {
            data: {
                payload: {
                    blob: archiveBuffer.toString('base64'),
                    performance: calculateStats(start, startUsage)
                },
                filename: `full_export_csv_${Date.now()}.zip`
            },
        });

    } catch (error) {
        console.error("CSV Export Error:", error);
        return sendResponse(res, 500, { message: "Error generating CSV archive" });
    }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Tue Jan 13 2026 14:30:59 GMT+0200 (Eastern European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
