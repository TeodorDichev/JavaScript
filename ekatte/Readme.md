# EKATTE Project

## База данни
Схемата на базата данни е в **третата нормална форма (3NF)** и включва данни за **селища, кметства, общини и области**. Типовете данни във всяка колона са строго съобразени с описанията в класификатора на НСИ: [линк](https://www.nsi.bg/nrnm/pages/nomenklatura).  
Поради честите заявки, включващи **JOIN** операции между таблиците, са добавени **индекси** върху колоните с външни ключове за оптимизация на производителността.

## Импортиране на данни в базата
Импортирането на данни се извършва от отделен проект, написан на **JavaScript** и използващ **Node.js**, което позволява стартиране директно от конзолата. Програмата проверява наличните файлове в папката `data` и ги показва на потребителя чрез конзолния интерфейс. Потребителят може да избере кои файлове да импортира, след което се задействат **транзакции** за запис в базата данни.  

Файлът `startUp.js` стартира програмата, обработва входа от конзолата и проверява наличието на файловете. В зависимост от избора на потребителя се стартира `jsonImport` или `excelImport`.  

И двата модула използват общи методи от `importCommon.js`:  
- **chunkArray** – разделя големи обеми данни на по-малки парчета за по-ефективно записване.  
- **normalizeMayoralityId** – проверява валидността на идентификационния код на кметство; ако кодът е невалиден, връща `null`.  
- **batchInsert** – създава динамично параметризирана SQL заявка за PostgreSQL за вкарване на данните, като автоматично пропуска дублирани записи. В рамките на **try-catch** блок се задейства транзакцията, която при проблем се **rollback-ва**.  

`jsonImport` и `excelImport` първо четат данните от файловете, филтрират записи с липсващи ID-та, нормализират данните и ги подават на `batchInsert`. За четене на Excel файлове се използва библиотеката **exceljs@4.4.0**.

## Интерфейс за търсене
Проектът **`search_ekatte`** съдържа **клиентска и сървърна част**.  

### Клиентска част
Разположена в папката `public` и се обслужва от **Node.js HTTP сървър** на порт **8000**, който предоставя статичните файлове (HTML, CSS, JS). Потребителят въвежда търсене в интерфейса, което чрез **AJAX** заявки се изпраща към бекенд сървъра на порт **3000**.  

### Бекенд сървър
Реализиран без frameworks като Express, ръчно настройва **CORS**, за да разреши безопасно извикване на API от фронтенд сървъра на различен порт (`http://localhost:8000`).  

Основният маршрут за търсене е дефиниран в **router.js**. Той обработва **GET** заявки с параметър `q` и връща **JSON** от базата данни, използвайки **JOIN** между таблиците `settlement`, `mayorality`, `municipality` и `region`.  
- Използват се **ILIKE** оператори за търсене без чувствителност към главни/малки букви.  
- Добавено е **ORDER BY** за сортиране по име на селището.  

### Работа на фронтенда
Файлът `index.js` слуша за въвеждане в полето за търсене, прави **debounced AJAX заявки** към API-то и рендерира резултатите в таблицата. Броят на намерените резултати се актуализира динамично. Всички DOM операции са изолирани във **DOMContentLoaded** слушател, за да се гарантира, че HTML е зареден преди скрипта да работи с него.

## Архитектура
- Пълна изолация между фронтенд и бекенд.  
- Лесно тестване и независими разширения на API-то.  
- Клиентът винаги получава актуални и валидни резултати от базата данни.
